---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by lele.
--- DateTime: 07/10/23 12:34
---

---@class TimedBook

local TimedBook = {}

local activityCalendar = require("lib/ActivityCalendar")
local characterManagement = require("CharacterManagement")
local errHandler = require("lib/ErrHandler")
local pageBook = require("PageBook")
local modDataManager = require("lib/ModDataManager")

-- TODO : collegare alla sandbox
local minimumDaysBeforeWriteBook = 1

--- **Scheduled Book Read From Hd**
---@return table double ( dateInSecond )
local function scheduledBookReadFromHd()
    return modDataManager.read(pageBook.Character.TIMED_BOOK)
end

--- **Read Book**
---@param character IsoGameCharacter
---@return void
--- - IsoGameCharacter : zombie.characters.IsoGameCharacter
function TimedBook.readBook(character)
    if not modDataManager.isExists(pageBook.Character.TIMED_BOOK) then
        return nil
    end

    characterManagement.readBook(character)
end

--- **Write Book To Hd**
---@param character IsoGameCharacter
---@return void
--- - IsoGameCharacter : zombie.characters.IsoGameCharacter
function TimedBook.writeBook(character)
    --- **Check if character is nil**
    if not character then
        errHandler.errMsg("ScheduledBookRead.writeBook(character)",
                errHandler.err.IS_NULL_CHARACTER)
        return nil
    end

    ---@type boolean
    local flag = false

    ---@type int
    local dateInSecond = 0

    --- **Check if scheduledBookRead is exits**
    if not modDataManager.isExists(
            pageBook.Character.TIMED_BOOK) then

        --- **Set Waiting Days**
        activityCalendar.setWaitingOfDays(minimumDaysBeforeWriteBook)

        --- **Get Expected Date In Seconds**
        dateInSecond = activityCalendar.getExpectedDateInSecond()
        flag = true
    else
        --- **Retrieve the date when it is possible to write a book**
        ---@type table - double
        local scheduledBookRead = scheduledBookReadFromHd()

        --- check if scheduledBookRead is nil
        if not scheduledBookRead then return nil end

        dateInSecond = scheduledBookRead[1]

        -- **Set scheduled BookRead**
        activityCalendar.setExpectedDateInSecond(dateInSecond)

        --- **Check if date is expected**
        if activityCalendar.isExpectedDate() then
            --- **Remove all mod data**
            characterManagement.removeAllModData()
            flag = true
        end
    end

    --- **Check if I can write the book**
    if flag then
        local lines = {}
        table.insert(lines, dateInSecond)
        --- **Remove scheduled BookRead date to mod data**
        modDataManager.remove(pageBook.Character.TIMED_BOOK)

        --- **Save scheduled BookRead date to mod data**
        modDataManager.save(pageBook.Character.TIMED_BOOK, lines)

        --- **Write Book**
        characterManagement.writeBook(character)
    end

    return flag
end

return TimedBook